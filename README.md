# OperationsGateway API
This is an API built using FastAPI to work with MongoDB and the data stored as part of the OperationsGateway project.


## Environment Setup
[Poetry](https://python-poetry.org/) is used to manage the dependencies of this API. To install Poetry, follow [the instructions](https://python-poetry.org/docs/master/#installing-with-the-official-installer) from their documentation.

To install the project's dependencies, execute `poetry install`. The dependencies and the code in this repo are compatible with Python 3.6+.

## Nox Sessions
Like DataGateway API, this repository contains a Nox file (`noxfile.py`) which exists in the root level of this repository. There are a handful of sessions which help with repetitive tasks during development To install Nox, use the following command:

```bash
pip install --user --upgrade nox
```

To run a specific Nox session, use the following:

```bash
nox -s [SESSION NAME]
```

Currently, the following Nox sessions have been created:
- `black` - this uses [Black](https://black.readthedocs.io/en/stable/) to format Python code to a pre-defined style.
- `lint` - this uses [flake8](https://flake8.pycqa.org/en/latest/) with a number of additional plugins (see the included `noxfile.py` to see which plugins are used) to lint the code to keep it Pythonic. `.flake8` configures `flake8` and the plugins.
- `safety` - this uses [safety](https://github.com/pyupio/safety) to check the dependencies (pulled directly from Poetry) for any known vulnerabilities. This session gives the output in a full ASCII style report.
- `tests` - this uses [pytest](https://docs.pytest.org/en/stable/) to execute the automated tests in `test/`. There are currently no automated tests written for this repository however.

## API Configuration
In `operationsgateway_api/`, there is an example config file (`config.yml.example`). Copy this example so `config.yml` exists in the same directory level and edit the configuration as needed for your system.

## Authentication Configuration

The authentication system uses JSON Web Tokens (JWTs) which require a private and public key pair to encrypt and decrypt the tokens. The keys can be generated by navigating to a directory and typing the command:

```bash
ssh-keygen -b 2048 -t rsa
```

Enter the path for the file as `id_rsa` to create the keys in the current directory rather than in your home directory.

Press enter twice when prompted for the password so as not to set one.

Then edit the ```private_key_path``` and ```public_key_path``` settings in the ```auth``` section of the ```config.yml``` file to reflect the location where these keys have been created.

### Adding User Accounts

The authentication system requires any users of the system to have an account set up in the database. Two types of user login are currently supported: federal ID logins for "real" users, and "local" logins for functional accounts.

To add some test accounts to the system copy the following text into a file ```users.json```:
```
{ "_id" : "rqw38472", "groups" : [ "admin" ], "auth_type" : "FedID" }
{ "_id" : "xfu59478", "groups" : [ "admin" ], "auth_type" : "FedID" }
{ "_id" : "frontend", "groups" : [ "reader" ], "auth_type" : "local", "sha256_password" : "2d8d693177ac44895fc02c009ec3f6af32e51eb00783c17000d7051d1662b93a" }
{ "_id" : "backend", "groups" : [ "reader" ], "auth_type" : "local", "sha256_password" : "3c482346f375027677fa8a0d6830a32714d4f13f9e94c2d9e215e0ac205ad4e5" }
{ "_id" : "hdf_import", "groups" : [ "importer" ], "auth_type" : "local", "sha256_password" : "d942f64886578d8747312e368ed92d9f6b2a8d45556f0f924e2444fe911d15af" }
{ "_id" : "no_auth_type_user" }
{ "_id" : "invalid_auth_type_user", "auth_type" : "Invalid" }
{ "_id" : "local_user_no_password", "groups" : [ "importer" ], "auth_type" : "local" }
```

Then use the following command to import those users into the database:

```bash
mongoimport --db='opsgateway' --collection='users' --file='users.json'
```

## API Startup
To start the API, use the following command:

```bash
poetry run python -m operationsgateway_api.src.main
```

Assuming default configuration, the API will exist on 127.0.0.1:8000. You can visit `/docs` in a browser which will give an OpenAPI interface detailing each of the endpoints and an option to send requests to them. Alternatively, you can send requests to the API using a platform such as Postman to construct and save specific requests.
